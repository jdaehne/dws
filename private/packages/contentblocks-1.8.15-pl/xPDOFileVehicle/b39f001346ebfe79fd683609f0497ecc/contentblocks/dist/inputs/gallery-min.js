!function(u,f){f.fieldTypes.gallery=function(s,d){var c={imageCount:0,fileBrowser:!1,source:0<d.properties.source?d.properties.source:ContentBlocksConfig["image.source"],directory:d.properties.directory,init:function(){this.initUpload(),(0<d.properties.thumbnail_size||d.properties.thumbnail_size&&1<d.properties.thumbnail_size.length)&&(d.properties.thumb_size="specified"),s.find(".contentblocks-field-gallery-list").addClass("gallery-size-"+d.properties.thumb_size),s.find(".contentblocks-field-upload").on("click",function(){s.find(".contentblocks-field-upload-field").click()}),s.find(".contentblocks-field-gallery-choose").on("click",u.proxy(function(){this.chooseImage()},this)),s.find(".contentblocks-field-gallery-url").on("click",u.proxy(function(){this.promptImage()},this)),MODx.load({xtype:"modx-treedrop",target:s,targetEl:s.get(0),onInsert:function(e){c.addImageFromUrl(e)}}),u.isArray(d.images)&&u.each(d.images,function(e,i){c.imageCount++,i.id=d.generated_id+"-image"+c.imageCount,i.width=i.width||0,i.height=i.height||0,c.addImage(i,"init")}),s.find(".gallery-image-holder").sortable({connectWith:".gallery-image-holder",forceHelperSize:!0,forcePlaceholderSize:!0,placeholder:"contentblocks-gallery-placeholder",tolerance:"pointer",cursor:"move",update:function(){f.fixColumnHeights(),f.fireChange()},start:function(e,i){i.placeholder.height(i.item.height())}}),f.toBoolean(d.properties.show_description)||s.addClass("no-description"),f.toBoolean(d.properties.show_link_field)||s.addClass("no-link-field")},chooseImage:function(){var e=d.properties.max_images,i=s.find(".gallery-image-holder").find("li").length;if(0<e&&e<=i)return f.alert(_("contentblocks.max_images_reached",{max:e})),!1;var t=MODx.load({xtype:"modx-browser",id:Ext.id(),multiple:!0,listeners:{select:function(e){c.chooseImageCallback(e)}},allowedFileTypes:d.properties.file_types,hideFiles:!0,title:_("contentblocks.choose_image"),source:c.source});t.setSource(c.source),t.show()},chooseImageCallback:function(e){var i=e.fullRelativeUrl;"http"!=i.substr(0,4)&&"/"!=i.substr(0,1)&&(i=MODx.config.base_url+i),c.imageCount++;var t=s.attr("id")+"-image"+c.imageCount,o=e.size,l=e.ext;this.addImage({url:i,title:e.filename,description:"",link:"",id:t,size:o,width:e.image_width,height:e.image_height,extension:l},"choose")},promptImage:function(){Ext.Msg.prompt(_("contentblocks.from_url_title"),_("contentblocks.from_url_prompt"),function(e,i,t){"ok"===e&&c.addImageFromUrl(i)},this)},addImageFromUrl:function(e){var i=s.find(".gallery-image-holder").find("li").length;if(0<d.properties.max_images&&i>=d.properties.max_images)return f.alert(_("contentblocks.max_images_reached",{max:d.properties.max_images})),!1;!e||e.length<3?f.alert("No URL provided."):(s.addClass("contentblocks-field-loading"),u.ajax({dataType:"json",url:ContentBlocksConfig.connector_url,type:"POST",beforeSend:function(e,i){i.crossDomain||e.setRequestHeader("modAuth",MODx.siteId)},data:{action:"content/image/download",field:d.field,resource:ContentBlocksResource&&ContentBlocksResource.id?ContentBlocksResource.id:0,url:e},context:this,success:function(e){if(s.removeClass("contentblocks-field-loading"),e.success){var i=f.utilities.normaliseUrls(e.object.url);c.imageCount++;var t=s.attr("id")+"-image"+c.imageCount;this.addImage({url:i.cleanedSrc,title:e.object.filename,description:"",link:"",id:t,size:e.object.size,width:e.object.width,height:e.object.height,extension:e.object.extension},"choose")}else f.alert(e.message)}}))},addImage:function(e,i){var t=s.find(".gallery-image-holder"),o=f.utilities.normaliseUrls(e.url);e.url=o.cleanedSrc,e.description=e.description||"",e.link=e.link||"",e.thumbDisplay=d.properties.thumbnail_size?f.utilities.getThumbnailUrl(e.url,d.properties.thumbnail_size):o.displaySrc,t.append(tmpl("contentblocks-field-gallery-item",e));var l=u("#"+e.id);l.find(".contentblocks-gallery-image-delete").on("click",function(){l.fadeOut(function(){l.remove(),f.fixColumnHeights(),f.fireChange()})}),f.toBoolean(d.properties.show_link_field)&&f.initializeLinkField(l.find(".linkfield"),d)},initUpload:function(){var a=s.attr("id"),r=d.properties.max_images;s.find("#"+a+"-upload").fileupload({url:ContentBlocksConfig.connectorUrl+"?action=content/image/upload",dataType:"json",dropZone:u("#"+a),progressInterval:250,paramName:"file",multiple:!0,pasteZone:null,add:function(e,i){var t=s.find(".gallery-image-holder").find("li").length;if(0<r&&r<=t)return f.alert(_("contentblocks.max_images_reached",{max:r})),!1;c.imageCount++;var o=a+"-image"+c.imageCount;i.files[0].ext=i.files[0].name.split(".").pop(),c.addImage({title:i.files[0].name,url:"",id:o,size:i.files[0].size,extension:i.files[0].ext},"upload"),i.domId="#"+o;var l=u(i.domId);if(l.addClass("uploading"),i.files[0].size<7e5&&window.FileReader){var n=new FileReader;n.onload=function(e){l.find("img").attr("src",e.target.result),f.fixColumnHeights()},n.readAsDataURL(i.files[0])}setTimeout(function(){i.submit()},1e3),f.fireChange()},done:function(e,i){var t=u(i.domId);if(i.result.success){var o=i.result.object,l=f.utilities.normaliseUrls(o.url);t.find(".url").val(l.cleanedSrc),t.find(".size").val(o.size),t.find(".width").val(o.width),t.find(".height").val(o.height),t.find(".extension").val(o.extension);var n=d.properties.thumbnail_size?f.utilities.getThumbnailUrl(o.url,d.properties.thumbnail_size):l.displaySrc;t.find("img").attr("src",n),t.removeClass("uploading")}else{var a=_("contentblocks.upload_error",{file:i.files[0].filename,message:i.result.message});1572864<i.files[0].size&&(a+=_("contentblocks.upload_error.file_too_big")),f.alert(a),t.remove()}setTimeout(function(){f.fixColumnHeights()},150)},fail:function(e,i){var t=_("contentblocks.upload_error",{file:i.files[0].filename,message:i.result.message});1572864<i.files[0].size&&(t+=_("contentblocks.upload_error.file_too_big")),f.alert(t),u(i.domId).remove(),f.fixColumnHeights()},formData:function(){return[{name:"HTTP_MODAUTH",value:MODx.siteId},{name:"resource",value:MODx.request.id||0},{name:"field",value:d.id}]},progress:function(e,i){var t=parseInt(i.loaded/i.total*100,10)+"%";u(i.domId).find(".upload-progress .bar").width(t)}}).on("fileuploaddragover",function(){u(this).css("background","red")})},getData:function(){var n=[];return s.find(".gallery-image-holder li").each(function(e,i){var t=u(i),o=t.find("input[id].linkfield"),l={url:t.find(".url").val(),title:t.find(".title").val(),description:t.find(".description").val(),link:o.val(),linkType:f.getLinkFieldDataType(o.val()),size:t.find(".size").val(),width:t.find(".width").val(),height:t.find(".height").val(),extension:t.find(".extension").val()};n.push(l)}),{images:n}}};return c}}(vcJquery,ContentBlocks);
//# sourceMappingURL=gallery-min.js.map